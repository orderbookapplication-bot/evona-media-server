const express = require("express");
const axios = require("axios");
const admin = require("firebase-admin");
const path = require("path");

const app = express();
app.use(express.json({ limit: "100mb" }));

// ================================
// FIREBASE INIT (ENV BASED)
// ================================

const serviceAccount = JSON.parse(process.env.FIREBASE_KEY_JSON);

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  storageBucket: "evona-media.firebasestorage.app"
});

const bucket = admin.storage().bucket();

// ================================
// FILE EXTENSION DETECTOR
// ================================

function getExtension(contentType) {
  if (contentType.includes("image/jpeg")) return ".jpg";
  if (contentType.includes("image/png")) return ".png";
  if (contentType.includes("image/webp")) return ".webp";
  if (contentType.includes("video/mp4")) return ".mp4";
  if (contentType.includes("application/pdf")) return ".pdf";
  return "";
}

// ================================
// MAIN API ENDPOINT
// ================================

app.post("/upload-from-appsheet", async (req, res) => {
  try {

    const { fileUrl } = req.body;

    if (!fileUrl) {
      return res.status(400).json({
        success: false,
        error: "fileUrl missing"
      });
    }

    console.log("Downloading:", fileUrl);

    // Download file from AppSheet
    const response = await axios.get(fileUrl, {
      responseType: "arraybuffer"
    });

    const contentType = response.headers["content-type"];
    const extension = getExtension(contentType);

    if (!extension) {
      return res.status(400).json({
        success: false,
        error: "Unsupported file type"
      });
    }

    const fileName = `uploads/${Date.now()}${extension}`;

    console.log("Uploading:", fileName);

    const file = bucket.file(fileName);

    // Upload to Firebase
    await file.save(response.data, {
      metadata: {
        contentType: contentType
      }
    });

    // Make public
    await file.makePublic();

    const publicUrl = `https://storage.googleapis.com/${bucket.name}/${fileName}`;

    console.log("Uploaded:", publicUrl);

    // Return FINAL RESPONSE
    res.json({
      success: true,
      url: publicUrl,
      type: contentType
    });

  } catch (error) {

    console.error("UPLOAD ERROR:", error.message);

    res.status(500).json({
      success: false,
      error: "Upload failed",
      details: error.message
    });

  }
});

// ================================
// SERVER START
// ================================

const PORT = process.env.PORT || 3000;

app.listen(PORT, () => {
  console.log("Evona Media Server Running on Port", PORT);
});

firebase-key.json
.env
node_modules
